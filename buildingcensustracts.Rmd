---
title: "Before_After"
output: pdf_document
date: "2025-06-16"
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

Reading packages
```{r}
library(leaflet)
library(sf)
library(mapview)
library(leaflet.extras)
library(tidyverse)
library(dplyr)
library(RColorBrewer)
```

Reading permit data
```{r}
megapermit <- read_csv("permitdatajun17")
```

Drop na of Long/Lat for Permit Data
```{r}
megapermit <- megapermit |>
  drop_na(LAT) |>
  drop_na(LON)
```

# Convert to permits to sf object
```{r}
megapermit_sf <- st_as_sf(megapermit, coords = c("LON", "LAT"), crs = 4326)
```

#Read in HPOZ sf
```{r}
hpoz_shp <- st_read("HPOZ/Historic_Preservation_Overlay_Zones.shp")
```
#Read in HPOZ founding dates
```{r}
hpoz_dates <- read_csv("hpoz_dates.csv")
```

#Join founding dates to hpoz shapefile
```{r}
hpoz_shp <- hpoz_shp |>
inner_join(hpoz_dates)
```

#Converting HPOZ to correct map projection
```{r message=FALSE, warning=FALSE}
hpoz_shp <- st_transform(hpoz_shp, crs = 4326)
```

The Highland Park HPOZ was founded in 1994 and thus cannot be included in a difference-in-difference analysis. However, it expanded to a non-contiguous area in the Garvanza neighborhood in 2010.These chunks seperate out Garvanza so it can be included in the analysis

# Extract just the Highland Park - Garvanza polygon
```{r}
garvanza <- hpoz_shp |>
  filter(NAME == "Highland Park - Garvanza")
```

```{r}
garvanza_parts <- garvanza |>
  st_cast("POLYGON") |>
  mutate(part_id = row_number())
```
```{r}
garvanza_selected <- garvanza_parts |>
  filter(part_id == 2)
```

```{r}
# Drop the original multi-part entry
hpoz_shp_cleaned <- hpoz_shp |>
  filter(NAME != "Highland Park - Garvanza")

# Add back the revised single-part version
garvanza_selected <- garvanza_selected |>
  select(-part_id)  # drop helper column

hpoz_shp <- bind_rows(hpoz_shp_cleaned, garvanza_selected)
```


#load in CA census tracts
```{r}
censustracts <- st_read("censustracts/tl_2022_06_tract.shp")
```

#Converting Census Tracts to correct projection
```{r}
censustracts <- st_transform(censustracts, crs = 4326)
```



#Filter to only LA County Census Tracts
```{r}
censustracts <- censustracts |>
  filter(COUNTYFP == "037")
```


##Get Census tract data into permit dataset

#Binary of whether Census Tract includes HPOZ
```{r}
censustracts <- censustracts |>
  mutate(hpoz_present = lengths(st_intersects(geometry, hpoz_shp)) > 0)
```

##Create variable in `censustracts` that determines which HPOZ is in Census Tract
```{r}
census_hpoz <- st_join(censustracts, hpoz_shp, left = TRUE, join = st_intersects)
```


#Create a summarized version if multiple HPOZs intersect a single tract, defaults to treatment being first HPOZ
```{r}
joined_summary <- census_hpoz |>
  group_by(GEOID) |>  # or whatever your unique tract ID is
  summarize(
    geometry = st_union(geometry),
    hpoz_present = any(hpoz_present),
    hpoz_name = first(NAME.y[!is.na(NAME.y)]),
    city_council = first(city_council[!is.na(city_council)]),
    tract_name = NAME.x
  )
```
```{r}
censustracts <- joined_summary
```




Remove time of day on `ISSUE_DATE` in permit data. Convert to standard date format
```{r}
megapermit_sf <- megapermit_sf |>
  mutate(SUBMITTED_DATE = gsub(" 12:00:00 AM", "", SUBMITTED_DATE),
         SUBMITTED_DATE = as.Date(SUBMITTED_DATE, format = "%m/%d/%Y"))
```

Convert `censustracts` HPOZ before and after treatment date to standard date format
```{r}
censustracts <- censustracts |>
  mutate(city_council = as.Date(city_council, format = "%m/%d/%Y"))
```

Make `hpoz_present` logical variable
```{r}
library(tidyr)
censustracts <- censustracts |>
  mutate(hpoz_present = as.logical(hpoz_present))

```

Spatially Join Permits to Tracts and HPOZs
```{r}
# Join permits to tracts (each permit gets tract attributes)
permits_with_tract <- st_join(megapermit_sf, censustracts, join = st_within, left = FALSE)

# Then check if each permit is inside an HPOZ
permits_with_hpoz <- st_join(permits_with_tract, hpoz_shp["NAME"], join = st_within, left = TRUE) |>
  mutate(in_hpoz = !is.na(NAME))
```


```{r}
# Classify permits using pre and post, treated and untreated
permits_with_hpoz <- permits_with_hpoz |>
  mutate(
    post = SUBMITTED_DATE >= city_council,
    treated = in_hpoz,
    DU_CHANGED = as.numeric(DU_CHANGED),
    tract_id = GEOID, 
    pre_untreated = if_else(!post & !treated, DU_CHANGED, 0),
    pre_treated   = if_else(!post &  treated, DU_CHANGED, 0),
    post_untreated = if_else( post & !treated, DU_CHANGED, 0),
    post_treated   = if_else( post &  treated, DU_CHANGED, 0)
  )
```




#Get rid of projects where permit and Certificate of Occupancy were not approved
```{r}
permits_with_hpoz <- permits_with_hpoz %>%
  filter(!(is.na(ISSUE_DATE) & is.na(COFO_DATE)))
```

Filter out expired permits
```{r}
permits_with_hpoz <- permits_with_hpoz |>
  filter(STATUS_DESC != "Permit Expired")
```

Get rid of duplicate rows
```{r}
permits_with_hpoz <- permits_with_hpoz |>
  distinct()
```


```{r}
test2 <- permits_with_hpoz |>
  filter(hpoz_present)
```

#Creating graphics of where permits have been relative to HPOZ before and after implementation
```{r}
test2 <- test2 |>
  mutate(temporalhpoz =
           ifelse(SUBMITTED_DATE > city_council, "AFTER", "BEFORE"))
```

```{r}
pre_properties <- test2 |>
  filter(temporalhpoz == "BEFORE") |>
  select(PRIMARY_ADDRESS, SUBMITTED_DATE, city_council)
```

```{r}
post_properties <- test2 |>
  filter(temporalhpoz == "AFTER") |>
  select(PRIMARY_ADDRESS, SUBMITTED_DATE, city_council)
```



#Checking unit counts within and outside of zone         



Summarize by tract
```{r}
du_sums_fixed <- permits_with_hpoz |>
  group_by(tract_id) |>
  summarize(
    pre_untreated = sum(pre_untreated, na.rm = TRUE),
    pre_treated = sum(pre_treated, na.rm = TRUE),
    post_untreated = sum(post_untreated, na.rm = TRUE),
    post_treated = sum(post_treated, na.rm = TRUE),
    .groups = "drop"
  )
```

Create count for tracts without HPOZ
```{r}
no_hpoz <- permits_with_hpoz |>
  filter(hpoz_present == FALSE) |>
  group_by(tract_id) |>
  summarize(no_hpoz_count = sum(DU_CHANGED, na.rm = TRUE), .groups = "drop")
```

```{r}
# Remove geometry column from du_sums and no_hpoz
du_sums_fixed <- du_sums_fixed |> st_drop_geometry()
no_hpoz <- no_hpoz |> st_drop_geometry()
```

Join all data back into `censustracts`
```{r}
censustracts <- censustracts |>
  left_join(du_sums_fixed, by = c("GEOID" = "tract_id")) |>
  left_join(no_hpoz, by = c("GEOID" = "tract_id")) |>
  mutate(across(
    c(pre_untreated, pre_treated, post_untreated, post_treated, no_hpoz_count),
    ~ replace_na(., 0)
  ))
```




#Filter out Census tracts that are in LA County but outside of the City of LA
```{r}
censustracts <- censustracts |>
   filter(!(pre_untreated == 0 & pre_treated == 0 & post_untreated == 0 &
              post_treated == 0 & no_hpoz_count == 0))
```


Removing duplicate tracts
```{r}
censustracts <- censustracts |>
  distinct()
```


#Renaming treatment (City Council Approval of an HPOZ District) to be clearer
```{r}
censustracts <- rename(censustracts, cc_hpoz_approval_treatment = city_council)
```




```{r}
# Filter to tracts that have HPOZs that were approved after Jan 9, 1995
hpoz_recent_tracts <- censustracts |>
  filter(
    hpoz_present == TRUE,
    cc_hpoz_approval_treatment > as.Date("1995-01-09")
  )
```

Filter out Census Tracts intersected by multiple HPOZs
```{r}
hpoz_recent_tracts <- hpoz_recent_tracts |>
filter(!(tract_name %in% 
           c("1898.01", "1898.02", "2189", "2214.01", "2214.02", "2168")))
```






```{r}
leaflet(data = pre_properties) |>
  addProviderTiles("CartoDB.Positron") |>
  addPolygons(data = hpoz_shp,
              weight = 1,
              label = hpoz_shp$NAME) |>
  addPolygons(data = hpoz_recent_tracts,
              fillOpacity = 0.5,
              color = "black",
              weight = 1.5,
              label = ~tract_name
              ) 
```



```{r}
leaflet(data = post_properties) |>
  addProviderTiles("CartoDB.Positron") |>
  addPolygons(data = hpoz_shp,
              weight = 1,
              label = hpoz_shp$NAME) |>
  addPolygons(data = hpoz_recent_tracts,
              fillOpacity = 0.0,
              color = "black",
              weight = 1.5
              ) |>
  addCircleMarkers(
    radius = 2,
    color=~ifelse(post_properties$in_hpoz=="TRUE" , "red", "green"),
    fillOpacity = 0.8,
    stroke = FALSE,
    label = post_properties$PRIMARY_ADDRESS
  )
```


```{r}
# Build the Leaflet map
leaflet(data = hpoz_recent_tracts) |>
  addProviderTiles("CartoDB.Positron") |>
  addPolygons(
    color = "#444444",
    weight = 1,
    smoothFactor = 0.5,
    opacity = 1.0,
    fillOpacity = 0.5,
    fillColor = "darkgreen",
    label = ~tract_name,  # Or any other identifier
    highlightOptions = highlightOptions(
      color = "white", weight = 2, bringToFront = TRUE)
  )
```




#Dropping geometry and exporting
```{r}
hpoz_recent_tracts |>
  st_drop_geometry() |>
   write_csv("d_in_d_jul16.csv")
 
```











